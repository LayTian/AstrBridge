## 目标与范围
- 把 HTTP 同步等回复从“按 user_id 等下一条”升级为“有 request_id 的可关联契约”，并补齐幂等与并发隔离。
- 强化会话/离线队列的持久化数据模型与清理/上限策略，支持重启一致性校验。
- 补齐可量化指标与导出（JSON + 可选 Prometheus），并把 CORS 策略体系化。
- 不做额外大堆 UI 功能（仅在需要展示指标时做最小可用改动）。

## 协议与一致性（request_id / 幂等 / 并发隔离）
- **定义统一的请求标识**
  - 新增 `request_id`：由服务端生成（UUID/随机 token），返回给调用方。
  - HTTP 同步接口返回 `reply` 时，把 `request_id` 一并带回（例如 `reply.meta.request_id`）。
- **并发隔离（同 user_id 多路业务）**
  - 将等待机制从“user_id → pending[]”改为：
    - `request_id → waiter`（真正的等待单元）
    - `user_id → request_id FIFO 队列`（收到该 user_id 的下一条机器人回复时，弹出一个 request_id 去 resolve）
  - 这样同一 user_id 可以并发发多次 `/request-reply`，每次都有明确 request_id，且不会互相覆盖。
  - 说明限制：如果 AstrBot 对同一 user_id 的回复乱序，我们按 FIFO 关联（写入文档，属于可控假设）。
- **幂等（idempotency）**
  - 支持 `Idempotency-Key`（header）或 `idempotency_key`（body）用于：
    - `/api/integrations/:id/events`
    - `/api/integrations/:id/request-reply`
  - 语义：同 key 在 TTL 内重复提交，返回第一次的结果（同步接口则返回同一 reply；若仍在等待中则复用同一个 in-flight promise）。
  - 实现：内存 + TTL（可选落盘），并在 metrics 中暴露命中次数。
- **接口形态**
  - 保留原 `/events`（异步投递）。
  - 强化 `/request-reply`：
    - 入参：`user_id/text/timeout_ms` + 可选 `idempotency_key`
    - 出参：`request_id` + `reply`（机器人回复报文）

## 持久化与可靠性（会话/队列数据模型、清理、上限、重启校验）
- **数据模型版本化**
  - sessions.json 增加 `schema_version` 与字段校验（缺字段默认值、类型不符丢弃）。
- **原子写入与备份**
  - 保存时写入临时文件再 rename，避免半写入导致 JSON 损坏。
  - 发现损坏时自动备份坏文件并恢复到空/上次可用。
- **上限策略**
  - 设定：
    - 单用户离线队列最大条数（例如 100/500，可配置）
    - 全局最大会话数（可配置）
  - 丢弃策略（例如丢最旧），并记录丢弃计数与原因（可观测）。
- **清理策略**
  - 定期清理长期离线且无队列的会话（TTL）。
  - 清理动作进入审计/日志（可选），并进入 metrics。
- **重启一致性验证**
  - 启动时输出加载摘要：会话数、队列总数、丢弃/修复情况。
  - 提供一个只读检查接口（例如 `GET /api/sessions/validate`）返回校验结果（可选）。

## 可观测性深度（指标体系 + 导出）
- **新增 MetricsHub（轻量实现）**
  - Counter：
    - integrations_events_total / integrations_request_reply_total
    - reply_delivered_total / reply_timeout_total
    - idempotency_hit_total
    - offline_enqueue_total / offline_drop_total
    - astrbot_reconnect_total / astrbot_disconnect_total
  - Gauge：
    - sessions_total / online_sessions / queued_messages_total
  - Histogram（滚动窗口即可）：
    - request_reply_latency_ms（P50/P95/P99）
- **导出接口**
  - `GET /api/metrics`：JSON 指标（适配你现有前端更容易接）。
  - 可选 `GET /metrics`：Prometheus 文本格式（写论文/扩展生态更加分）。
- **最小 UI 改动（可选）**
  - Analytics 页面加一个“系统指标”卡片，展示关键数字 + P95 延迟（不做复杂图表也能答辩）。

## CORS（只做你要求的跨域部分）
- 增加可配置的允许来源：`CORS_ALLOW_ORIGINS`（逗号分隔）。
- 对 `/api/integrations/*` 默认允许跨域（按 allow list），并处理 `OPTIONS` 预检。
- 如需 cookie（/api/auth）跨域：明确 `Access-Control-Allow-Credentials` 与 `SameSite` 策略（文档说明 dev/prod 差异）。

## 文档与示例同步
- README：
  - 更新 `/request-reply` 契约（request_id、幂等、并发语义、FIFO 假设）。
  - 增加 metrics 导出说明。
- 接入中心（web-admin）：
  - API 示例更新：增加 request_id/幂等示例。
- api-demo.html：
  - 增加 idempotency_key 输入框与 request_id 展示区。
  - 同步/异步模式清晰区分。

## 验证与测试
- 新增/补齐 smoke 测试：
  - 并发 2 个 request-reply（同 user_id）能分别拿到带 request_id 的 reply。
  - Idempotency-Key 重放返回相同结果。
  - timeout 正确返回 504。
  - 队列上限触发时 drop 计数增长。
- 运行现有 build/test，保证不破坏 web-admin 与后端编译。

如果你确认，我会按上述顺序先落地“request_id + 幂等 + 并发隔离 + 指标基础”，再做持久化与 CORS 的体系化收尾。