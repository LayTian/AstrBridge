## 目标与原则
- 目标：工程达到“毕设可交付”水准（可运行、可演示、可写论文）。
- 原则：安全性不做过度复杂，但按你要求采用 **Dual-token（Access + Refresh）**，实现“过期自动续签、无感登录”的标准体验。

## Dual-token 机制定义（本项目口径）
- **Access Token**：短期（例如 15min），用于访问 `/api/*`，放在 `Authorization: Bearer <access>`。
- **Refresh Token**：长期（例如 7d），仅用于换取新的 Access Token。
- 存储策略（推荐简化 + 体验好）：
  - Refresh Token 放 **httpOnly Cookie**（前端拿不到、减少泄漏风险，且实现上不依赖额外库）。
  - Access Token 仍由前端存储（现有 [auth.ts](file:///e:/adpater/web-admin/src/auth.ts) 模式可沿用）并通过 axios 拦截器附带。

## 角色设计（结合你之前要求的“可选超级密钥”）
- 角色两种：`admin` 与 `super_admin`。
- 登录页提供“超级密钥（可选）”，后端校验：匹配则签发 role=super_admin 的 token，否则 role=admin。
- 高危操作仅 super_admin：踢人/改配置。

## Phase 1：鉴权重构为 Dual-token（先打通闭环）
1. **后端新增/调整接口**（集中在 [index.ts](file:///e:/adpater/src/index.ts)）
   - `POST /api/auth/login`：入参 `{ username, password, super_key? }`
     - 返回：`{ access_token, expires_at, role }`
     - 同时 `Set-Cookie: refresh_token=...; HttpOnly; Path=/api/auth; SameSite=Lax`（开发环境不加 Secure，https 下加 Secure）
   - `POST /api/auth/refresh`：读取 refresh_token cookie
     - 成功：返回新的 `{ access_token, expires_at, role }`（可同时滚动刷新 refresh token）
     - 失败：401
   - `POST /api/auth/logout`：清除 refresh_token cookie + 返回 ok
2. **后端鉴权中间件调整**
   - 移除 `ADMIN_TOKEN` 固定 token 模式（按你之前意见）。
   - `/api/auth/login|refresh|logout` 放行。
   - 其他 `/api/*` 必须校验 access token：签名 + `exp` + `typ=access` + role。
3. **环境变量（最简但可配置）**
   - `ADMIN_USERNAME` / `ADMIN_PASSWORD`
   - `ADMIN_TOKEN_SECRET`（用于签名，可同时签 access/refresh）
   - `ACCESS_TOKEN_TTL_SECONDS`（默认 900）
   - `REFRESH_TOKEN_TTL_SECONDS`（默认 604800）
   - `SUPER_ADMIN_KEY`（可选）

## Phase 2：前端接入 Dual-token（无感续签）
1. **登录页调整**（[Login.vue](file:///e:/adpater/web-admin/src/views/Login.vue)）
   - 增加“超级密钥（可选）”输入框。
   - 登录调用 `/api/auth/login`，只保存 access_token + expires_at + role（refresh 在 cookie）。
2. **axios 拦截器改造**（[main.ts](file:///e:/adpater/web-admin/src/main.ts)）
   - 请求前：若 access 过期/即将过期 → 先 `POST /api/auth/refresh` 获取新 access，再重放原请求。
   - 响应 401：尝试 refresh 一次；失败则清理本地并跳 `/login`。
3. **本地 auth 工具增强**（[auth.ts](file:///e:/adpater/web-admin/src/auth.ts)）
   - 保存 role，提供 `getRole()` 供 UI 控权。

## Phase 3：RBAC（双角色 + 高危操作隔离）
1. **后端权限校验**
   - `POST /api/sessions/:id/kick`：仅 super_admin。
   - 未来如提供“服务端配置管理接口”同样仅 super_admin。
2. **前端 UI 控权**
   - 会话页踢人按钮、设置页高危配置仅 super_admin 可见/可点。

## Phase 4：审计日志（毕设加分项）
- 记录：登录（含 role）、refresh、logout、踢人、改配置、发消息等；增加审计页面筛选/导出。

## Phase 5：健康度评分 + 告警（演示效果最好）
- 后端提供 `/api/metrics/health` 输出 score + breakdown；前端 [Analytics.vue](file:///e:/adpater/web-admin/src/views/Analytics.vue) 展示。

## Phase 6：测试与交付文档（答辩关键）
- 测试：login/refresh/logout、access 过期自动续签、RBAC（admin 无法踢人，super_admin 可以）。
- 文档：.env 说明、接口说明、演示脚本、截图清单。

## 验收标准
- 访问后台：未登录 → /login。
- 登录后：Access 过期时自动 refresh，无需手动重新登录。
- 高危操作：只有填写超级密钥登录的 super_admin 才能执行。

如果你确认这个 Dual-token 方案，我将按 Phase 1 → Phase 2 → Phase 3 顺序实现，并在每一步保证可运行可演示。