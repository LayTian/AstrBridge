<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>运行状态 · AstrBridge</title>
    <meta name="description" content="AstrBridge 运行状态与健康度面板（公开只读）。" />
    <style>
      :root {
        --bg: #070b14;
        --border: rgba(148, 163, 184, 0.22);
        --panel: rgba(255, 255, 255, 0.05);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(226, 232, 240, 0.68);
        --muted2: rgba(226, 232, 240, 0.55);
        --ok: #22c55e;
        --warn: #f59e0b;
        --bad: #ef4444;
        --brand: #60a5fa;
        --shadow: 0 18px 55px rgba(0, 0, 0, 0.55);
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
      }

      body {
        color: var(--text);
        background: radial-gradient(1200px 900px at 15% 10%, rgba(96, 165, 250, 0.18), rgba(7, 11, 20, 0)),
          radial-gradient(900px 800px at 80% 0%, rgba(34, 197, 94, 0.12), rgba(7, 11, 20, 0)),
          radial-gradient(900px 700px at 85% 75%, rgba(239, 68, 68, 0.12), rgba(7, 11, 20, 0)),
          var(--bg);
        font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, PingFang SC, Microsoft YaHei, Arial, sans-serif;
        line-height: 1.6;
      }

      a {
        color: inherit;
        text-decoration: none;
      }

      .container {
        max-width: 1120px;
        margin: 0 auto;
        padding: 22px 20px 70px;
      }

      .topnav {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        border-radius: 16px;
        border: 1px solid var(--border);
        background: rgba(7, 11, 20, 0.55);
        backdrop-filter: blur(10px);
      }

      .brand {
        font-weight: 900;
        letter-spacing: 0.2px;
      }

      .pill {
        margin-left: auto;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 7px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.04);
        color: var(--muted);
        font-weight: 800;
        font-size: 12px;
      }

      .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: rgba(148, 163, 184, 0.7);
        box-shadow: 0 0 0 4px rgba(148, 163, 184, 0.15);
      }

      .grid {
        margin-top: 14px;
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 12px;
      }

      .card {
        grid-column: span 4;
        padding: 18px 16px;
        border-radius: 18px;
        border: 1px solid var(--border);
        background: var(--panel);
        box-shadow: var(--shadow);
      }

      .cardWide {
        grid-column: span 12;
      }

      .k {
        color: var(--muted2);
        font-weight: 800;
        font-size: 12px;
        letter-spacing: 0.2px;
      }

      .v {
        margin-top: 6px;
        font-weight: 900;
        font-size: 22px;
        letter-spacing: -0.2px;
      }

      .sub {
        margin-top: 6px;
        color: var(--muted);
        font-size: 13px;
      }

      .row {
        margin-top: 10px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        border-radius: 14px;
        padding: 10px 12px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.04);
        color: rgba(255, 255, 255, 0.92);
        font-weight: 900;
        font-size: 13px;
      }

      .btn:hover {
        background: rgba(255, 255, 255, 0.07);
      }

      .meterWrap {
        margin-top: 10px;
        border: 1px solid rgba(148, 163, 184, 0.18);
        background: rgba(255, 255, 255, 0.03);
        border-radius: 14px;
        overflow: hidden;
      }

      .meter {
        height: 10px;
        width: 0%;
        background: linear-gradient(90deg, rgba(34, 197, 94, 1), rgba(96, 165, 250, 1));
        transition: width 240ms ease;
      }

      .foot {
        margin-top: 14px;
        color: var(--muted2);
        font-size: 12px;
      }

      @media (max-width: 980px) {
        .card {
          grid-column: span 6;
        }
      }

      @media (max-width: 620px) {
        .card {
          grid-column: span 12;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="topnav">
        <div class="brand">AstrBridge · 运行状态</div>
        <div class="pill"><span class="dot" id="dot"></span><span id="statusText">加载中</span></div>
      </div>

      <div class="grid">
        <div class="card">
          <div class="k">健康度</div>
          <div class="v" id="healthScore">--</div>
          <div class="sub" id="healthLevel">--</div>
          <div class="meterWrap"><div class="meter" id="healthMeter"></div></div>
        </div>
        <div class="card">
          <div class="k">AstrBot 连接</div>
          <div class="v" id="astrbot">--</div>
          <div class="sub">连接状态</div>
        </div>
        <div class="card">
          <div class="k">服务运行时间</div>
          <div class="v" id="uptime">--</div>
          <div class="sub">进程运行时长</div>
        </div>

        <div class="card">
          <div class="k">在线用户数</div>
          <div class="v" id="online">--</div>
          <div class="sub">有活跃 WebSocket 连接</div>
        </div>
        <div class="card">
          <div class="k">会话总数</div>
          <div class="v" id="sessions">--</div>
          <div class="sub">含离线会话</div>
        </div>
        <div class="card">
          <div class="k">离线队列积压</div>
          <div class="v" id="queued">--</div>
          <div class="sub">所有用户队列累计</div>
        </div>

        <div class="card cardWide">
          <div class="row">
            <div>
              <div class="k">说明</div>
              <div class="sub" id="reasons">--</div>
            </div>
            <div class="row">
              <a class="btn" href="/">返回首页</a>
              <a class="btn" href="/docs/">接口文档</a>
              <a class="btn" href="/openapi.json" target="_blank" rel="noreferrer">规范 JSON</a>
            </div>
          </div>
          <div class="foot">该页面公开只读；管理功能与更多指标请进入管理后台。</div>
        </div>
      </div>
    </div>

    <script>
      (function () {
        const $ = (id) => document.getElementById(id);
        const dot = $('dot');
        const statusText = $('statusText');
        const healthScore = $('healthScore');
        const healthLevel = $('healthLevel');
        const healthMeter = $('healthMeter');
        const astrbot = $('astrbot');
        const uptime = $('uptime');
        const online = $('online');
        const sessions = $('sessions');
        const queued = $('queued');
        const reasons = $('reasons');

        const fmtUptime = (sec) => {
          const s = Math.max(0, Math.floor(Number(sec) || 0));
          const d = Math.floor(s / 86400);
          const h = Math.floor((s % 86400) / 3600);
          const m = Math.floor((s % 3600) / 60);
          const ss = s % 60;
          if (d > 0) return `${d}天 ${h}小时 ${m}分`;
          if (h > 0) return `${h}小时 ${m}分`;
          if (m > 0) return `${m}分 ${ss}秒`;
          return `${ss}秒`;
        };

        const setDot = (kind) => {
          const map = {
            ok: { c: 'rgba(34, 197, 94, 1)', s: 'rgba(34, 197, 94, 0.15)' },
            warn: { c: 'rgba(245, 158, 11, 1)', s: 'rgba(245, 158, 11, 0.18)' },
            bad: { c: 'rgba(239, 68, 68, 1)', s: 'rgba(239, 68, 68, 0.18)' },
            idle: { c: 'rgba(148, 163, 184, 0.7)', s: 'rgba(148, 163, 184, 0.15)' }
          };
          const v = map[kind] || map.idle;
          dot.style.background = v.c;
          dot.style.boxShadow = `0 0 0 4px ${v.s}`;
        };

        const fetchJson = async (url) => {
          const r = await fetch(url, { cache: 'no-store' });
          const j = await r.json();
          return { ok: r.ok, status: r.status, json: j };
        };

        const refresh = async () => {
          try {
            const [pub, health] = await Promise.all([
              fetchJson('/api/public/status'),
              fetchJson('/api/metrics/health')
            ]);

            if (!pub.ok) throw new Error(`status_${pub.status}`);
            if (!health.ok) throw new Error(`health_${health.status}`);

            const s = pub.json || {};
            const h = (health.json && health.json.data) || {};

            const score = Number(h.score);
            const level = String(h.level || '');
            const scoreSafe = Number.isFinite(score) ? Math.max(0, Math.min(100, score)) : 0;

            healthScore.textContent = Number.isFinite(score) ? `${scoreSafe}` : '--';
            const levelText = level === 'ok' ? '正常' : level === 'degraded' ? '降级' : level === 'down' ? '故障' : '未知';
            healthLevel.textContent = `等级：${levelText}`;
            healthMeter.style.width = `${scoreSafe}%`;

            const astr = s.astrbot_connected ? '已连接' : '未连接';
            astrbot.textContent = astr;
            uptime.textContent = fmtUptime(s.uptime);
            online.textContent = String(s.online_users ?? '--');
            sessions.textContent = String(s.total_sessions ?? '--');
            queued.textContent = String(s.queued_messages ?? '--');

            const rs = Array.isArray(h.reasons) && h.reasons.length ? h.reasons : ['状态良好'];
            reasons.textContent = rs.join('；');

            const overall = scoreSafe >= 90 ? 'ok' : scoreSafe >= 60 ? 'warn' : 'bad';
            setDot(overall);
            statusText.textContent = overall === 'ok' ? '运行正常' : overall === 'warn' ? '需要关注' : '异常';
          } catch (e) {
            setDot('idle');
            statusText.textContent = '暂不可用';
          }
        };

        refresh();
        setInterval(refresh, 3000);
      })();
    </script>
  </body>
</html>
