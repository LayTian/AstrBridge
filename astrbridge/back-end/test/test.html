<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>AstrBot Web 适配器测试</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f9; max-width: 800px; margin: 0 auto; }
        .config-area { margin-bottom: 20px; padding: 15px; background: #fff; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        #chat { height: 400px; border: 1px solid #ddd; overflow-y: scroll; background: white; padding: 15px; margin-bottom: 15px; border-radius: 8px; box-shadow: inset 0 0 10px rgba(0,0,0,0.02); }
        .msg-row { margin-bottom: 10px; display: flex; flex-direction: column; }
        .user { align-items: flex-end; }
        .bot { align-items: flex-start; }
        .bubble { padding: 8px 12px; border-radius: 12px; max-width: 70%; word-wrap: break-word; }
        .user .bubble { background: #007bff; color: white; border-bottom-right-radius: 2px; }
        .bot .bubble { background: #e9ecef; color: #333; border-bottom-left-radius: 2px; }
        .system { text-align: center; color: #888; font-size: 12px; margin: 5px 0; }
        .input-area { display: flex; gap: 10px; }
        input { padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; }
        button.disconnect { background: #dc3545; }
        button.disconnect:hover { background: #c82333; }
    </style>
</head>
<body>
    <h2>AstrBot Web 客户端模拟器</h2>
    
    <div class="config-area">
        <label>用户 ID: <input type="text" id="userId" value=""></label>
        <button type="button" onclick="resetUserId()">重置ID</button>
        <button id="connectBtn" onclick="toggleConnection()">连接</button>
        <span id="status" style="margin-left: 10px; color: #888;">未连接</span>
    </div>

    <div id="chat"></div>
    
    <div class="input-area">
        <input type="text" id="msg" placeholder="输入消息..." style="flex: 1;" onkeypress="if(event.key === 'Enter') send()">
        <button onclick="send()" id="sendBtn" disabled>发送</button>
    </div>

    <script>
        let ws = null;
        let pingInterval = null;

        function generateUserId() {
            const n = 1000000000 + Math.floor(Math.random() * 9000000000);
            return String(n);
        }

        function initUserId() {
            try {
                const existing = localStorage.getItem('adapter_user_id');
                if (existing && /^\d+$/.test(existing)) {
                    document.getElementById('userId').value = existing;
                    return;
                }
            } catch (e) {}
            const created = generateUserId();
            document.getElementById('userId').value = created;
            try { localStorage.setItem('adapter_user_id', created); } catch (e) {}
        }

        function resetUserId() {
            if (ws) return alert('请先断开连接再重置');
            const created = generateUserId();
            document.getElementById('userId').value = created;
            try { localStorage.setItem('adapter_user_id', created); } catch (e) {}
            appendSystemMsg('已重置 User ID');
        }

        function toggleConnection() {
            if (ws) {
                ws.close();
            } else {
                connect();
            }
        }

        function connect() {
            const uid = document.getElementById('userId').value;
            if (!uid) return alert('请输入 User ID');

            ws = new WebSocket(`ws://localhost:8080?user_id=${uid}`);

            ws.onopen = () => {
                console.log('Connected');
                updateStatus(true);
                appendSystemMsg('已连接到服务器');
                startHeartbeat();
            };

            ws.onclose = () => {
                console.log('Disconnected');
                updateStatus(false);
                appendSystemMsg('连接已断开');
                stopHeartbeat();
                ws = null;
            };

            ws.onerror = (err) => {
                console.error('WebSocket Error', err);
                appendSystemMsg('连接发生错误');
            };

            ws.onmessage = (event) => {
                if (event.data === 'PONG') return;
                
                try {
                    const data = JSON.parse(event.data);
                    if (data.event === 'message_reply') {
                        appendMsg('AstrBot', data.payload?.text, 'bot');
                    } else if (data.error) {
                        appendSystemMsg(`错误: ${data.error}`);
                    } else {
                        appendMsg('System', JSON.stringify(data), 'bot');
                    }
                } catch (e) {
                    console.log('Received:', event.data);
                }
            };
        }

        function send() {
            if (!ws) return;
            const text = document.getElementById('msg').value;
            if (!text) return;

            const uid = document.getElementById('userId').value;
            const message = {
                event: 'message_new',
                payload: {
                    text: text,
                    metadata: { user_id: uid, session_id: 'session_' + uid }
                }
            };
            ws.send(JSON.stringify(message));
            appendMsg('Me', text, 'user');
            document.getElementById('msg').value = '';
        }

        function appendMsg(sender, text, type) {
            const chat = document.getElementById('chat');
            const div = document.createElement('div');
            div.className = `msg-row ${type}`;
            div.innerHTML = `<div class="bubble"><strong>${sender}:</strong> ${text}</div>`;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function appendSystemMsg(text) {
            const chat = document.getElementById('chat');
            chat.innerHTML += `<div class="system">${text}</div>`;
            chat.scrollTop = chat.scrollHeight;
        }

        function updateStatus(connected) {
            const btn = document.getElementById('connectBtn');
            const status = document.getElementById('status');
            const input = document.getElementById('userId');
            const sendBtn = document.getElementById('sendBtn');

            if (connected) {
                btn.textContent = '断开';
                btn.className = 'disconnect';
                status.textContent = '已连接';
                status.style.color = 'green';
                input.disabled = true;
                sendBtn.disabled = false;
            } else {
                btn.textContent = '连接';
                btn.className = '';
                status.textContent = '未连接';
                status.style.color = '#888';
                input.disabled = false;
                sendBtn.disabled = true;
            }
        }

        function startHeartbeat() {
            pingInterval = setInterval(() => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send('PING');
                }
            }, 30000);
        }

        function stopHeartbeat() {
            if (pingInterval) clearInterval(pingInterval);
        }

        initUserId();
    </script>
</body>
</html>
